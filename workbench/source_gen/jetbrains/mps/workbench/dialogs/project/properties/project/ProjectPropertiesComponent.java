package jetbrains.mps.workbench.dialogs.project.properties.project;

/*Generated by MPS */

import javax.swing.JPanel;
import jetbrains.mps.logging.Logger;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.extensions.Extensions;
import java.awt.BorderLayout;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import com.intellij.openapi.options.ConfigurationException;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.project.MPSProject;

public class ProjectPropertiesComponent extends JPanel {
  private static final Logger LOG = Logger.getLogger(ProjectPropertiesComponent.class);

  private Project myProject;
  private ProjectProperties myEditableDescriptor = new ProjectProperties();
  private ProjectPropertiesDialog myPropertiesDialog;
  private ProjectPrefsExtraPanel[] myExtraPanels;

  public ProjectPropertiesComponent(Project project) {
    myProject = project;
    myExtraPanels = Extensions.getExtensions(ProjectPrefsExtraPanel.EP_NAME, myProject);
    myPropertiesDialog = new ProjectPropertiesDialog(myProject, myEditableDescriptor, myExtraPanels);
    initUI();
  }

  public void addNotify() {
    super.addNotify();
    myPropertiesDialog.bindData();
  }

  public void removeNotify() {
    super.removeNotify();
    myPropertiesDialog.unbindData();
  }

  private void initUI() {
    setLayout(new BorderLayout());
    add(myPropertiesDialog.getMainComponent(), BorderLayout.CENTER);
  }

  public boolean isModified() {
    return !(myEditableDescriptor.isSame(getMPSProject().getProjectDescriptor())) || Sequence.fromIterable(Sequence.fromArray(myExtraPanels)).any(new IWhereFilter<ProjectPrefsExtraPanel>() {
      public boolean accept(ProjectPrefsExtraPanel ep) {
        return ep.isModified();
      }
    });
  }

  public void apply() throws ConfigurationException {
    ModelAccess.instance().runWriteAction(new Runnable() {
      public void run() {
        myEditableDescriptor.saveTo(getMPSProject());
      }
    });
    for (ProjectPrefsExtraPanel ep : myExtraPanels) {
      ep.apply();
    }
  }

  public void reset() {
    for (ProjectPrefsExtraPanel ep : myExtraPanels) {
      ep.reset();
    }
    try {
      myEditableDescriptor.loadFrom(getMPSProject());
    } catch (Throwable t) {
      LOG.error("This should not be thrown", t);
    }
  }

  private MPSProject getMPSProject() {
    return myProject.getComponent(MPSProject.class);
  }
}

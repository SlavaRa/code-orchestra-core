package jetbrains.mps.workbench.dialogs.project.properties.project;

/*Generated by MPS */

import jetbrains.mps.workbench.dialogs.project.BaseStretchingBindedDialog;
import com.intellij.openapi.project.Project;
import jetbrains.mps.project.ProjectOperationContext;
import jetbrains.mps.ide.properties.StandardComponents;
import jetbrains.mps.workbench.dialogs.project.BaseBindedDialog;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.ide.dialogs.DialogDimensionsSettings;
import jetbrains.mps.ide.dialogs.BaseDialog;

public final class ProjectPropertiesDialog extends BaseStretchingBindedDialog {
  private Project myProject;
  private ProjectProperties myProperties;
  private ProjectPrefsExtraPanel[] myExtraPanels;

  public ProjectPropertiesDialog(final Project project) {
    super(project.getName() + " Properties", ProjectOperationContext.get(project));
    myProject = project;
    collectProjectProperties();
    initUI();
  }

  public ProjectPropertiesDialog(final Project project, ProjectProperties properties, ProjectPrefsExtraPanel[] extraPanels) {
    super(project.getName() + " Properties", ProjectOperationContext.get(project));
    myProject = project;
    myProperties = properties;
    myExtraPanels = extraPanels;
    initUI();
  }

  private void initUI() {
    addComponent(StandardComponents.createProjectModulesPanel(this, "Modules", myProperties.getModules()), BaseBindedDialog.ConstraintsType.LIST);
    addComponent(StandardComponents.createTestConfigsPanel(this, "Test Configurations", myProperties.getTestConfigurations(), myProperties), BaseBindedDialog.ConstraintsType.LIST);
    for (ProjectPrefsExtraPanel extraPanel : Sequence.fromIterable(Sequence.fromArray(myExtraPanels))) {
      addComponent(extraPanel.getComponent(), BaseBindedDialog.ConstraintsType.LIST);
    }
  }

  private void collectProjectProperties() {
    myProperties = new ProjectProperties();
    myProperties.loadFrom(getMPSProject());
  }

  private MPSProject getMPSProject() {
    return myProject.getComponent(MPSProject.class);
  }

  protected boolean doSaveChanges() {
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        myProperties.saveTo(getMPSProject());
        myProject.save();
      }
    });
    return true;
  }

  public DialogDimensionsSettings.DialogDimensions getDefaultDimensionSettings() {
    return new DialogDimensionsSettings.DialogDimensions(200, 200, 500, 700);
  }

  public void bindData() {
    super.bind();
  }

  public void unbindData() {
    super.unbind();
  }

  @BaseDialog.Button(position = 0, name = "OK", mnemonic = 'O', defaultButton = true)
  public void buttonOK() {
    if (!(saveChanges())) {
      return;
    }
    dispose();
  }

  @BaseDialog.Button(position = 1, name = "Cancel", mnemonic = 'C')
  public void buttonCancel() {
    dispose();
  }

  @BaseDialog.Button(position = 2, name = "Apply", mnemonic = 'A')
  public void buttonApply() {
    saveChanges();
  }
}

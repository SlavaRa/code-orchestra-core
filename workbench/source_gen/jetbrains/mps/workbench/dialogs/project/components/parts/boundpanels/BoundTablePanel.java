package jetbrains.mps.workbench.dialogs.project.components.parts.boundpanels;

/*Generated by MPS */

import javax.swing.JTable;
import java.util.List;
import jetbrains.mps.workbench.dialogs.project.components.parts.descriptors.ColumnDescriptor;
import java.util.ArrayList;
import jetbrains.mps.workbench.dialogs.project.IBindedDialog;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.workbench.dialogs.project.components.parts.actions.BaseValidatedAction;
import com.intellij.openapi.util.Computable;
import javax.swing.JComponent;
import jetbrains.mps.workbench.dialogs.project.components.parts.diffrowtable.DiffRowTable;
import com.intellij.ui.table.JBTable;
import org.jdesktop.swingbinding.JTableBinding;
import org.jdesktop.swingbinding.SwingBindings;
import org.jdesktop.beansbinding.AutoBinding;
import org.jdesktop.beansbinding.Property;
import org.jdesktop.beansbinding.BeanProperty;
import javax.swing.table.TableColumn;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableCellEditor;
import javax.swing.JTextField;
import javax.swing.DefaultCellEditor;
import java.util.EventObject;
import javax.swing.ListSelectionModel;
import jetbrains.mps.workbench.dialogs.project.components.parts.actions.TableRemoveAction;
import com.intellij.openapi.actionSystem.AnActionEvent;
import com.intellij.openapi.ui.Messages;
import jetbrains.mps.workbench.dialogs.project.components.parts.actions.TableAddAction;

public class BoundTablePanel<T> extends ValidateableBoundPanel<T> {
  private JTable myTable;
  private boolean myDiffRow;
  private List<ColumnDescriptor> myColumns = new ArrayList<ColumnDescriptor>();

  public BoundTablePanel(IBindedDialog owner, String caption, @NotNull List<T> ts) {
    super(owner, caption, ts);
  }

  public void addColumn(ColumnDescriptor d) {
    myColumns.add(d);
  }

  public void setDiffRow(boolean isDiffRow) {
    myDiffRow = isDiffRow;
  }

  public JTable getTable() {
    return myTable;
  }

  protected BaseValidatedAction createAddAction(final Computable<List<T>> chooser) {
    return new BoundTablePanel.MyTableAddAction(chooser);
  }

  protected BaseValidatedAction createRemoveAction() {
    return new BoundTablePanel.MyTableRemoveAction(myTable);
  }

  protected int[] getSelectedIndices() {
    return myTable.getSelectedRows();
  }

  protected JComponent initUIComponentAndBinding() {
    myTable = (myDiffRow ?
      new DiffRowTable() :
      new JBTable()
    );
    JTableBinding<T, List<T>, JTable> tableBinding = SwingBindings.createJTableBinding(AutoBinding.UpdateStrategy.READ_WRITE, myList, myTable);
    for (final ColumnDescriptor d : myColumns) {
      tableBinding.addColumnBinding((Property<T, ?>) BeanProperty.create(d.getName()));
    }
    tableBinding.bind();
    myOwner.addBinding(tableBinding);
    int i = 0;
    for (final ColumnDescriptor d : myColumns) {
      TableColumn column = myTable.getColumnModel().getColumn(i);
      column.setHeaderValue(d.getHeader());
      if (d.getWidth() > 0) {
        column.setWidth(d.getWidth());
        column.setMaxWidth(d.getWidth());
      }
      column.setResizable(true);
      TableCellRenderer renderer = d.createRenderer();
      if (renderer != null) {
        column.setCellRenderer(renderer);
      }
      TableCellEditor editor = d.createEditor();
      if (editor != null) {
        column.setCellEditor(editor);
      } else {
        JTextField text = new JTextField();
        text.setOpaque(true);
        text.setEditable(false);
        column.setCellEditor(new DefaultCellEditor(text) {
          public boolean isCellEditable(EventObject anEvent) {
            return false;
          }
        });
      }
      i++;
    }
    myTable.setSelectionMode((multipleChooserSet() ?
      ListSelectionModel.MULTIPLE_INTERVAL_SELECTION :
      ListSelectionModel.SINGLE_INTERVAL_SELECTION
    ));
    return myTable;
  }

  private class MyTableRemoveAction extends TableRemoveAction {
    public MyTableRemoveAction(JTable table) {
      super(table);
    }

    protected void doRemove(AnActionEvent e) {
      String errorMessage = BoundTablePanel.this.removeSelectedWithCheck();
      if (errorMessage.length() != 0) {
        Messages.showWarningDialog("<html>Can't remove " + errorMessage + ".</html>", "Error Removing Element");
      }
    }
  }

  private class MyTableAddAction<T> extends TableAddAction {
    private final Computable<List<T>> myChooser;

    public MyTableAddAction(Computable<List<T>> chooser) {
      super(myTable);
      myChooser = chooser;
    }

    protected int doAdd(AnActionEvent e) {
      List<T> chosen = myChooser.compute();
      if (chosen == null) {
        return -1;
      }
      BoundTablePanel.this.myList.addAll((List) chosen);
      super.doAdd(e);
      T first = ((chosen.isEmpty() ?
        null :
        chosen.get(0)
      ));
      return ((first == null) ?
        -1 :
        BoundTablePanel.this.myList.indexOf(first)
      );
    }
  }
}

package jetbrains.mps.ide.findusages.findalgorithm.finders;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.lang.ref.WeakReference;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import com.intellij.openapi.progress.ProgressIndicator;

public class ReloadableFinder implements IInterfacedFinder {
  private static final Logger LOG = Logger.getLogger(ReloadableFinder.class);

  private ModuleClassReference<GeneratedFinder> myModuleClassRef;
  private WeakReference<GeneratedFinder> myFinder = new WeakReference<GeneratedFinder>(null);

  public ReloadableFinder(ModuleReference moduleRef, String finderClass) {
    myModuleClassRef = new ModuleClassReference(moduleRef, finderClass);
  }

  public ReloadableFinder(ModuleReference moduleReference, GeneratedFinder finder) {
    this(moduleReference, finder.getClass().getName());
    myFinder = new WeakReference<GeneratedFinder>(finder);
  }

  public GeneratedFinder getFinder() {
    if (myFinder.get() == null) {
      Class<GeneratedFinder> finderClass = myModuleClassRef.loadClass();
      GeneratedFinder finder = null;
      try {
        finder = finderClass.newInstance();
      } catch (Throwable t) {
        LOG.error(t);
        return null;
      }
      myFinder = new WeakReference<GeneratedFinder>(finder);
    }
    return myFinder.get();
  }

  public String getConcept() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return "";
    }
    return finder.getConcept();
  }

  public boolean isApplicable(SNode node) {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return false;
    }
    return finder.isApplicable(node);
  }

  public boolean isVisible(SNode node) {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return false;
    }
    return finder.isVisible(node);
  }

  public String getDescription() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return "";
    }
    return finder.getDescription();
  }

  public String getLongDescription() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return "";
    }
    return finder.getLongDescription();
  }

  public boolean canNavigate() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return false;
    }
    return finder.canNavigate();
  }

  public SNode getNodeToNavigate() {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return null;
    }
    return finder.getNodeToNavigate();
  }

  public SearchResults<SNode> find(SearchQuery query, ProgressIndicator indicator) {
    GeneratedFinder finder = getFinder();
    if (finder == null) {
      return new SearchResults();
    }
    return finder.find(query, indicator);
  }
}

package jetbrains.mps.baseLanguage.javadoc.editor;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.EditorContext;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.action.SNodeFactoryOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;

public class TextCommentPartUtil {
  public static void processCellText(EditorContext editorContext, final SNode node, final String newText) {
    final Wrappers._int index = new Wrappers._int(newText.indexOf("{@"));
    if (index.value != -1) {
      SNode tagPart;
      divideLineBetweenCaret(node, index.value, index.value + 2, newText);
      tagPart = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.javadoc.structure.InlineTagCommentLinePart", null);
      SNodeOperations.insertNextSiblingChild(node, tagPart);
      return;
    }
    index.value = newText.indexOf("{{");
    if (index.value != -1) {
      SNode codeSnippet;
      SNode nextLine = divideLineBetweenCaretAndInsertNewLine(node, index.value, index.value + 2, newText);
      codeSnippet = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.javadoc.structure.CodeSnippet", null);
      SNodeOperations.insertPrevSiblingChild(nextLine, codeSnippet);
      editorContext.selectWRTFocusPolicy(codeSnippet);
      return;
    }
    index.value = newText.indexOf("<");
    if (index.value != -1) {
      final Wrappers._T<SNode> htmlElement = new Wrappers._T<SNode>();
      ModelAccess.instance().runWriteActionInCommand(new Runnable() {
        public void run() {
          divideLineBetweenCaret(node, index.value, index.value + 1, newText);

          htmlElement.value = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.javadoc.structure.HTMLElement", null);
          SNodeOperations.insertNextSiblingChild(node, htmlElement.value);
        }
      });
      editorContext.selectWRTFocusPolicy(htmlElement.value);
      return;
    }
  }

  public static void divideLineBetweenCaret(SNode node, int index1, int index2, String text) {
    String leftPart = text.substring(0, index1);
    String rightPart = text.substring(index2);

    SPropertyOperations.set(node, "text", leftPart);

    SNode newTextPart = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.javadoc.structure.TextCommentLinePart", null);
    SPropertyOperations.set(newTextPart, "text", rightPart);
    SNodeOperations.insertNextSiblingChild(node, newTextPart);
  }

  public static SNode divideLineBetweenCaretAndInsertNewLine(SNode node, int index1, int index2, String text) {
    String leftPart = text.substring(0, index1);
    String rightPart = text.substring(index2);

    SNode thisLine = SNodeOperations.cast(SNodeOperations.getParent(node), "jetbrains.mps.baseLanguage.javadoc.structure.CommentLine");
    SNode nextLine = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.javadoc.structure.CommentLine", null);
    SPropertyOperations.set(SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(nextLine, "part", true)).getElement(0), "jetbrains.mps.baseLanguage.javadoc.structure.TextCommentLinePart"), "text", rightPart);
    SNodeOperations.insertNextSiblingChild(thisLine, nextLine);

    int indexInParent = SNodeOperations.getIndexInParent(node);
    SPropertyOperations.set(SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(thisLine, "part", true)).getElement(indexInParent), "jetbrains.mps.baseLanguage.javadoc.structure.TextCommentLinePart"), "text", leftPart);

    while (ListSequence.fromList(SLinkOperations.getTargets(thisLine, "part", true)).count() > indexInParent + 1) {
      SNode linePart = ListSequence.fromList(SLinkOperations.getTargets(thisLine, "part", true)).getElement(indexInParent + 1);
      SNodeOperations.detachNode(linePart);
      ListSequence.fromList(SLinkOperations.getTargets(nextLine, "part", true)).addElement(linePart);
    }

    return nextLine;
  }
}

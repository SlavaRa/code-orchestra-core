package jetbrains.mps.baseLanguage.refactorings;

/*Generated by MPS */

import jetbrains.mps.refactoring.framework.BaseRefactoring;
import jetbrains.mps.refactoring.framework.IRefactoringTarget;
import jetbrains.mps.refactoring.framework.RefactoringContext;
import jetbrains.mps.baseLanguage.util.plugin.refactorings.ChangeMethodSignatureDialog;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.List;
import jetbrains.mps.baseLanguage.util.plugin.refactorings.ChangeMethodSignatureRefactoring;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.ide.findusages.view.FindUtils;
import com.intellij.openapi.progress.EmptyProgressIndicator;
import jetbrains.mps.project.GlobalScope;
import java.util.ArrayList;
import jetbrains.mps.ide.findusages.model.SearchResult;

public class ChangeMethodSignature extends BaseRefactoring {
  public ChangeMethodSignature() {
    this.addTransientParameter("myRefactorings");
  }

  public String getUserFriendlyName() {
    return "Change Method Signature";
  }

  public String getKeyStroke() {
    return getKeyStroke_static();
  }

  public IRefactoringTarget getRefactoringTarget() {
    return new ChangeMethodSignature_Target();
  }

  public boolean init(final RefactoringContext refactoringContext) {
    ChangeMethodSignatureDialog dialog = new ChangeMethodSignatureDialog(refactoringContext.getSelectedNode(), refactoringContext.getCurrentOperationContext());
    dialog.showDialog();
    dialog.pack();
    refactoringContext.setParameter("myRefactorings", dialog.getAllRefactorings());
    if (ListSequence.fromList(((List<ChangeMethodSignatureRefactoring>) refactoringContext.getParameter("myRefactorings"))).isEmpty()) {
      return false;
    } else {
      return true;
    }
  }

  public void refactor(final RefactoringContext refactoringContext) {
    for (ChangeMethodSignatureRefactoring ref : ListSequence.fromList(((List<ChangeMethodSignatureRefactoring>) refactoringContext.getParameter("myRefactorings")))) {
      ref.doRefactoring();
    }
  }

  public SearchResults getAffectedNodes(final RefactoringContext refactoringContext) {
    SearchResults<SNode> allResults = new SearchResults();
    for (ChangeMethodSignatureRefactoring ref : ListSequence.fromList(((List<ChangeMethodSignatureRefactoring>) refactoringContext.getParameter("myRefactorings")))) {
      SearchResults<SNode> curResults = FindUtils.getSearchResults(new EmptyProgressIndicator(), ref.getDeclaration(), GlobalScope.getInstance(), "jetbrains.mps.baseLanguage.findUsages.ExactMethodUsages_Finder");
      List<SNode> usages = new ArrayList<SNode>();
      for (SearchResult<SNode> result : ListSequence.fromList(curResults.getSearchResults())) {
        ListSequence.fromList(usages).addElement(result.getObject());
      }
      ref.setUsages(usages);
      allResults.addAll(curResults);
    }
    return allResults;
  }

  public static String getKeyStroke_static() {
    return "ctrl F6";
  }
}

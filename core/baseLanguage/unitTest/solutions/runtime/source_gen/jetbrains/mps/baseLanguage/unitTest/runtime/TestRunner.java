package jetbrains.mps.baseLanguage.unitTest.runtime;

/*Generated by MPS */

import java.util.List;
import org.junit.runner.Request;
import java.io.FileNotFoundException;
import java.io.IOException;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.io.File;
import java.io.LineNumberReader;
import java.io.FileReader;
import java.util.ArrayList;
import org.apache.commons.lang.StringUtils;
import org.junit.runner.JUnitCore;
import java.io.PrintStream;
import org.junit.runner.notification.RunListener;
import org.junit.runner.Description;
import org.junit.runner.notification.Failure;

public class TestRunner {
  public TestRunner() {
  }

  private void loadTests(String[] argv, List<Request> requests) throws ClassNotFoundException, FileNotFoundException, IOException {
    for (int i = 0; i < argv.length; i++) {
      if ("-c".equals(argv[i])) {
        i++;
        String className = argv[i];
        ListSequence.fromList(requests).addElement(this.createClassRequest(className));
      } else if ("-m".equals(argv[i])) {
        i++;
        String s = argv[i];
        int index = s.lastIndexOf('.');
        String testCase = s.substring(0, index);
        String method = s.substring(index + 1);
        ListSequence.fromList(requests).addElement(this.createMethodRequest(testCase, method));
      } else if ("-f".equals(argv[i])) {
        i++;
        String filename = argv[i];
        new File(filename).deleteOnExit();
        LineNumberReader reader = new LineNumberReader(new FileReader(filename));
        List<String> fileContents = ListSequence.fromList(new ArrayList<String>());
        while (true) {
          String line = reader.readLine();
          if (line == null) {
            break;
          }
          if (StringUtils.isEmpty(line)) {
            continue;
          }
          ListSequence.fromList(fileContents).addElement(line);
        }
        loadTests(ListSequence.fromList(fileContents).toGenericArray(String.class), requests);
      }
    }
  }

  protected Request createMethodRequest(String testCase, String method) throws ClassNotFoundException {
    // protected just for the sake of symmetry with createClassRequest 
    return Request.method(Class.forName(testCase), method);
  }

  protected Request createClassRequest(String className) throws ClassNotFoundException {
    return Request.aClass(Class.forName(className));
  }

  protected void executeTestsFromArguments(String[] args) throws IOException, ClassNotFoundException, FileNotFoundException {
    JUnitCore core = new JUnitCore();

    CommandOutputStream out = new CommandOutputStream(System.out);
    CommandOutputStream err = new CommandOutputStream(System.err);
    System.setOut(new PrintStream(out));
    System.setErr(new PrintStream(err));
    core.addListener(new TestRunner.MyRunListener(out, err));

    List<Request> requests = ListSequence.fromList(new ArrayList<Request>());
    loadTests(args, requests);

    for (Request request : ListSequence.fromList(requests)) {
      core.run(request);
    }
  }

  public static void main(String[] args) throws ClassNotFoundException, FileNotFoundException, IOException {
    new TestRunner().executeTestsFromArguments(args);
  }

  private static class MyRunListener extends RunListener {
    private final CommandOutputStream myOutput;
    private final CommandOutputStream myErrorOutput;

    public MyRunListener(CommandOutputStream out, CommandOutputStream err) {
      myOutput = out;
      myErrorOutput = err;
    }

    @Override
    public void testFinished(Description description) throws Exception {
      this.printSyncToken(TestEvent.END_TEST_PREFIX, description);
      super.testFinished(description);
    }

    @Override
    public void testFailure(Failure failure) throws Exception {
      this.printSyncToken(TestEvent.ERROR_TEST_PREFIX, failure.getDescription());
      failure.getException().printStackTrace(System.out);
      this.printSyncToken(TestEvent.ERROR_TEST_SUFFIX, failure.getDescription());
      super.testFailure(failure);
    }

    @Override
    public void testAssumptionFailure(Failure failure) {
      this.printSyncToken(TestEvent.FAILURE_TEST_PREFIX, failure.getDescription());
      failure.getException().printStackTrace(System.out);
      this.printSyncToken(TestEvent.FAILURE_TEST_SUFFIX, failure.getDescription());
      super.testAssumptionFailure(failure);
    }

    @Override
    public void testStarted(Description description) throws Exception {
      printSyncToken(TestEvent.START_TEST_PREFIX, description);
      super.testStarted(description);
    }

    private void printSyncToken(String tokenPrefix, Description description) {
      TestEvent testEvent = new TestEvent(tokenPrefix, description);
      String out = testEvent.toString();
      synchronized (this.myOutput) {
        this.myOutput.writeCommand(out);
        myOutput.flushSafe();
      }
    }
  }
}

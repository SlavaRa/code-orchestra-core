package jetbrains.mps.baseLanguage.runConfigurations.scripts;

/*Generated by MPS */

import jetbrains.mps.smodel.SModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ISequenceClosure;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.SModelReference;
import java.util.List;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.smodel.SReference;

public class ScriptsUtil {
  public ScriptsUtil() {
  }

  public static Iterable<SModel.ImportElement> getImports(final SModel model, final String longName) {
    return Sequence.fromIterable(Sequence.fromClosure(new ISequenceClosure<SModel.ImportElement>() {
      public Iterable<SModel.ImportElement> iterable() {
        return model.importedModels();
      }
    })).where(new IWhereFilter<SModel.ImportElement>() {
      public boolean accept(SModel.ImportElement it) {
        return it.getModelReference().getLongName().equals(longName);
      }
    });
  }

  public static void updateNode(final SNode node, String longName, SModelReference newModelReference) {
    List<SModel.ImportElement> imports = Sequence.fromIterable(ScriptsUtil.getImports(SNodeOperations.getModel(node), longName)).toListSequence();
    ListSequence.fromList(imports).visitAll(new IVisitor<SModel.ImportElement>() {
      public void visit(SModel.ImportElement it) {
        SNodeOperations.getModel(node).deleteModelImport(it.getModelReference());
      }
    });

    SNodeOperations.getModel(node).addModelImport(newModelReference, false);
    for (SNode chileNode : ListSequence.fromList(SNodeOperations.getDescendants(node, null, true, new String[]{}))) {
      List<SReference> references = chileNode.getReferences();
      for (SReference ref : ListSequence.fromList(references)) {
        if (ref.getTargetSModelReference().getLongName().equals(longName)) {
          ref.setTargetSModelReference(newModelReference);
        }
      }
    }
  }
}

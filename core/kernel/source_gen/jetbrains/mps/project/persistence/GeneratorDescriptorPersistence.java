package jetbrains.mps.project.persistence;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import jetbrains.mps.project.structure.modules.GeneratorDescriptor;
import org.jdom.Element;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.util.Macros;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.xmlQuery.runtime.AttributeUtils;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingPriorityRule;
import jetbrains.mps.project.structure.modules.mappingpriorities.RuleType;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_AbstractRef;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_RefAllLocal;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_RefAllGlobal;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_SimpleRef;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_ExternalRef;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_RefSet;

public class GeneratorDescriptorPersistence {
  protected static Log log = LogFactory.getLog(GeneratorDescriptorPersistence.class);

  private GeneratorDescriptorPersistence() {
  }

  public static GeneratorDescriptor loadGeneratorDescriptor(final Element generatorElement, final IFile file, final Macros macros) {
    GeneratorDescriptor descriptor = new _FunctionTypes._return_P0_E0<GeneratorDescriptor>() {
      public GeneratorDescriptor invoke() {
        final GeneratorDescriptor result_wk2vdq_a0a0a0a = new GeneratorDescriptor();
        String genUID = generatorElement.getAttributeValue("generatorUID");
        final String result_wk2vdq_a1a0a0a0a = genUID;
        result_wk2vdq_a0a0a0a.setGeneratorUID(result_wk2vdq_a1a0a0a0a);
        final boolean result_wk2vdq_a2a0a0a0a = AttributeUtils.booleanWithDefault(generatorElement.getAttributeValue("generate-templates"), false);
        result_wk2vdq_a0a0a0a.setGenerateTemplates(result_wk2vdq_a2a0a0a0a);

        if (generatorElement.getAttributeValue("uuid") != null) {
          final String result_wk2vdq_a0a4a0a0a0a = generatorElement.getAttributeValue("uuid");
          result_wk2vdq_a0a0a0a.setUUID(result_wk2vdq_a0a4a0a0a0a);
        }

        if (generatorElement.getAttributeValue("name") != null) {
          final String result_wk2vdq_a0a6a0a0a0a = generatorElement.getAttributeValue("name");
          result_wk2vdq_a0a0a0a.setNamespace(result_wk2vdq_a0a6a0a0a0a);
        }

        if (ListSequence.fromList(AttributeUtils.elementChildren(generatorElement, "models")).isNotEmpty()) {
          result_wk2vdq_a0a0a0a.getModelRoots().addAll(ModuleDescriptorPersistence.loadModelRoots(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(generatorElement, "models")).first(), "modelRoot"), file, macros));
        } else {
          // old - for backwards compatibility 
          result_wk2vdq_a0a0a0a.getModelRoots().addAll(ModuleDescriptorPersistence.loadModelRoots(AttributeUtils.elementChildren(generatorElement, "modelRoot"), file, macros));
        }


        ModuleDescriptorPersistence.loadDependencies(result_wk2vdq_a0a0a0a, generatorElement);

        // "depends on" generators 
        for (Element refGenerator : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(generatorElement, "external-templates")).first(), "generator"))) {
          result_wk2vdq_a0a0a0a.getDepGenerators().add(ModuleReference.fromString(refGenerator.getAttributeValue("generatorUID")));
        }

        for (Element ruleElement : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(generatorElement, "mapping-priorities")).first(), "mapping-priority-rule"))) {
          final MappingPriorityRule result_wk2vdq_a0a61a0a0a0a = new MappingPriorityRule();
          // TODO: remove when the error disappear. Remove trim() also 
          try {
            final RuleType result_wk2vdq_a0a1a0a61a0a0a0a = RuleType.parse(ruleElement.getAttributeValue("kind").trim());
            result_wk2vdq_a0a61a0a0a0a.setType(result_wk2vdq_a0a1a0a61a0a0a0a);
          } catch (IllegalArgumentException e) {
            if (log.isErrorEnabled()) {
              log.error(e.getMessage() + " Rule type for generator " + genUID + " is set to EQUALS. You can change this in Generator Properties dialog.", e);
            }
            final RuleType result_wk2vdq_a1a0b0a0q0a0a0a0 = RuleType.STRICTLY_TOGETHER;
            result_wk2vdq_a0a61a0a0a0a.setType(result_wk2vdq_a1a0b0a0q0a0a0a0);
          }

          if (ListSequence.fromList(AttributeUtils.elementChildren(ruleElement, "greater-priority-mapping")).isNotEmpty()) {
            final MappingConfig_AbstractRef result_wk2vdq_a0a3a0a61a0a0a0a = loadGeneratorMappingConfigRef(ListSequence.fromList(AttributeUtils.elementChildren(ruleElement, "greater-priority-mapping")).first(), genUID, false);
            result_wk2vdq_a0a61a0a0a0a.setLeft(result_wk2vdq_a0a3a0a61a0a0a0a);
          }
          if (ListSequence.fromList(AttributeUtils.elementChildren(ruleElement, "lesser-priority-mapping")).isNotEmpty()) {
            final MappingConfig_AbstractRef result_wk2vdq_a0a4a0a61a0a0a0a = loadGeneratorMappingConfigRef(ListSequence.fromList(AttributeUtils.elementChildren(ruleElement, "lesser-priority-mapping")).first(), genUID, false);
            result_wk2vdq_a0a61a0a0a0a.setRight(result_wk2vdq_a0a4a0a61a0a0a0a);
          }
          result_wk2vdq_a0a0a0a.getPriorityRules().add(result_wk2vdq_a0a61a0a0a0a);
        }
        return result_wk2vdq_a0a0a0a;
      }
    }.invoke();
    ModuleDescriptorPersistence.setTimestamp(descriptor, file);
    return descriptor;
  }

  public static void saveGeneratorDescriptor(Element languageGeneratorsElement, GeneratorDescriptor descriptor, IFile file, Macros macros) {
    Element result_wk2vdq_a0a1 = languageGeneratorsElement;
    final Element result_wk2vdq_a0a0a1 = new Element("generator");
    if (descriptor.getNamespace() != null) {
      final String result_wk2vdq_a0a0a0a0a1 = descriptor.getNamespace();
      result_wk2vdq_a0a0a1.setAttribute("name", "" + result_wk2vdq_a0a0a0a0a1);
    }
    if (descriptor.getGeneratorUID() != null) {
      final String result_wk2vdq_a0a1a0a0a1 = descriptor.getGeneratorUID();
      result_wk2vdq_a0a0a1.setAttribute("generatorUID", "" + result_wk2vdq_a0a1a0a0a1);
    }
    if (descriptor.getUUID() != null) {
      final String result_wk2vdq_a0a2a0a0a1 = descriptor.getUUID();
      result_wk2vdq_a0a0a1.setAttribute("uuid", "" + result_wk2vdq_a0a2a0a0a1);
    }
    if (descriptor.isGenerateTemplates()) {
      final boolean result_wk2vdq_a0a3a0a0a1 = descriptor.isGenerateTemplates();
      result_wk2vdq_a0a0a1.setAttribute("generate-templates", "" + result_wk2vdq_a0a3a0a0a1);
    }

    final Element result_wk2vdq_a5a0a0a1 = new Element("models");
    ModuleDescriptorPersistence.saveModelRoots(result_wk2vdq_a5a0a0a1, descriptor.getModelRoots(), file, macros);
    result_wk2vdq_a0a0a1.addContent(result_wk2vdq_a5a0a0a1);

    // "depends on" generators 
    final Element result_wk2vdq_a8a0a0a1 = new Element("external-templates");
    for (ModuleReference generatorReference : ListSequence.fromList(descriptor.getDepGenerators())) {
      final Element result_wk2vdq_a0a0a8a0a0a1 = new Element("generator");
      final String result_wk2vdq_a0a0a0a8a0a0a1 = generatorReference.toString();
      result_wk2vdq_a0a0a8a0a0a1.setAttribute("generatorUID", "" + result_wk2vdq_a0a0a0a8a0a0a1);
      result_wk2vdq_a8a0a0a1.addContent(result_wk2vdq_a0a0a8a0a0a1);
    }
    result_wk2vdq_a0a0a1.addContent(result_wk2vdq_a8a0a0a1);

    ModuleDescriptorPersistence.saveDependencies(result_wk2vdq_a0a0a1, descriptor);

    // mapping priority rules 
    final Element result_wk2vdq_a31a0a0a1 = new Element("mapping-priorities");
    for (MappingPriorityRule rule : ListSequence.fromList(descriptor.getPriorityRules())) {
      final Element result_wk2vdq_a0a0a31a0a0a1 = new Element("mapping-priority-rule");
      final String result_wk2vdq_a0a0a0a31a0a0a1 = rule.getType().getName();
      result_wk2vdq_a0a0a31a0a0a1.setAttribute("kind", "" + result_wk2vdq_a0a0a0a31a0a0a1);
      final Element result_wk2vdq_a1a0a0a31a0a0a1 = new Element("greater-priority-mapping");
      saveGeneratorMappingConfigRef(rule.getLeft(), result_wk2vdq_a1a0a0a31a0a0a1);
      result_wk2vdq_a0a0a31a0a0a1.addContent(result_wk2vdq_a1a0a0a31a0a0a1);
      final Element result_wk2vdq_a2a0a0a31a0a0a1 = new Element("lesser-priority-mapping");
      saveGeneratorMappingConfigRef(rule.getRight(), result_wk2vdq_a2a0a0a31a0a0a1);
      result_wk2vdq_a0a0a31a0a0a1.addContent(result_wk2vdq_a2a0a0a31a0a0a1);
      result_wk2vdq_a31a0a0a1.addContent(result_wk2vdq_a0a0a31a0a0a1);
    }
    result_wk2vdq_a0a0a1.addContent(result_wk2vdq_a31a0a0a1);

    // Refresh was removed here, since this method is only called in 
    // LanguageDescriptorPersistence.saveLanguageDescriptor method, 
    // which does refresh at the en 
    result_wk2vdq_a0a1.addContent(result_wk2vdq_a0a0a1);
  }

  private static void saveGeneratorMappingConfigRef(MappingConfig_AbstractRef mappingRef, Element parentElement) {
    Element result_wk2vdq_a0a2 = parentElement;
    if (mappingRef instanceof MappingConfig_RefAllLocal) {
      final Element result_wk2vdq_a0a0a0a2 = new Element("all-local-mappings");
      result_wk2vdq_a0a2.addContent(result_wk2vdq_a0a0a0a2);
    } else if (mappingRef instanceof MappingConfig_RefAllGlobal) {
      final Element result_wk2vdq_a0a0a0a0c = new Element("all-mappings");
      result_wk2vdq_a0a2.addContent(result_wk2vdq_a0a0a0a0c);
    } else if (mappingRef instanceof MappingConfig_SimpleRef) {
      final Element result_wk2vdq_a0a1a0a0c = new Element("mapping-node");
      final String result_wk2vdq_a0a0a1a0a0c = ((MappingConfig_SimpleRef) mappingRef).getModelUID();
      result_wk2vdq_a0a1a0a0c.setAttribute("modelUID", "" + result_wk2vdq_a0a0a1a0a0c);
      final String result_wk2vdq_a1a0a1a0a0c = ((MappingConfig_SimpleRef) mappingRef).getNodeID();
      result_wk2vdq_a0a1a0a0c.setAttribute("nodeID", "" + result_wk2vdq_a1a0a1a0a0c);
      result_wk2vdq_a0a2.addContent(result_wk2vdq_a0a1a0a0c);
    } else if (mappingRef instanceof MappingConfig_ExternalRef) {
      final Element result_wk2vdq_a0a2a0a0c = new Element("generator");
      final String result_wk2vdq_a0a0a2a0a0c = ((MappingConfig_ExternalRef) mappingRef).getGenerator().toString();
      result_wk2vdq_a0a2a0a0c.setAttribute("generatorUID", "" + result_wk2vdq_a0a0a2a0a0c);
      result_wk2vdq_a0a2.addContent(result_wk2vdq_a0a2a0a0c);
      final Element result_wk2vdq_a1a2a0a0c = new Element("external-mapping");
      saveGeneratorMappingConfigRef(((MappingConfig_ExternalRef) mappingRef).getMappingConfig(), result_wk2vdq_a1a2a0a0c);
      result_wk2vdq_a0a2.addContent(result_wk2vdq_a1a2a0a0c);
    } else if (mappingRef instanceof MappingConfig_RefSet) {
      final Element result_wk2vdq_a0a3a0a0c = new Element("mapping-set");
      for (MappingConfig_AbstractRef mappingRefInner : ListSequence.fromList(((MappingConfig_RefSet) mappingRef).getMappingConfigs())) {
        final Element result_wk2vdq_a0a0a0a3a0a0c = new Element("mapping-set-element");
        saveGeneratorMappingConfigRef(mappingRefInner, result_wk2vdq_a0a0a0a3a0a0c);
        result_wk2vdq_a0a3a0a0c.addContent(result_wk2vdq_a0a0a0a3a0a0c);
      }
      result_wk2vdq_a0a2.addContent(result_wk2vdq_a0a3a0a0c);
    }
  }

  public static MappingConfig_AbstractRef loadGeneratorMappingConfigRef(final Element parentElement, final String genUID, boolean childOfGen) {
    if (ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "all-mappings")).isNotEmpty()) {
      return new MappingConfig_RefAllGlobal();
    } else if (ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "all-local-mappings")).isNotEmpty()) {
      final MappingConfig_RefAllLocal local = new MappingConfig_RefAllLocal();
      if (childOfGen) {
        return local;
      }

      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a3a0a0d = new MappingConfig_ExternalRef();
          final ModuleReference result_wk2vdq_a0a0a3a0a0d = ModuleReference.fromString(genUID);
          result_wk2vdq_a0a3a0a0d.setGenerator(result_wk2vdq_a0a0a3a0a0d);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a3a0a0d = local;
          result_wk2vdq_a0a3a0a0d.setMappingConfig(result_wk2vdq_a1a0a3a0a0d);
          return result_wk2vdq_a0a3a0a0d;
        }
      }.invoke();
    } else if (ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "mapping-set")).isNotEmpty()) {
      final MappingConfig_RefSet mappingSet = new MappingConfig_RefSet();
      for (Element mappingSetElement : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "mapping-set")).first(), "mapping-set-element"))) {
        mappingSet.getMappingConfigs().add(loadGeneratorMappingConfigRef(mappingSetElement, genUID, true));
      }

      if (childOfGen) {
        return mappingSet;
      }

      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a5a1a0d = new MappingConfig_ExternalRef();
          final ModuleReference result_wk2vdq_a0a0a5a1a0d = ModuleReference.fromString(genUID);
          result_wk2vdq_a0a5a1a0d.setGenerator(result_wk2vdq_a0a0a5a1a0d);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a5a1a0d = mappingSet;
          result_wk2vdq_a0a5a1a0d.setMappingConfig(result_wk2vdq_a1a0a5a1a0d);
          return result_wk2vdq_a0a5a1a0d;
        }
      }.invoke();
    } else if (ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "generator")).isNotEmpty()) {
      // external reference 
      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a1a2a0d = new MappingConfig_ExternalRef();
          final ModuleReference result_wk2vdq_a0a0a1a2a0d = ModuleReference.fromString(ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "generator")).first().getAttributeValue("generatorUID"));
          result_wk2vdq_a0a1a2a0d.setGenerator(result_wk2vdq_a0a0a1a2a0d);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a1a2a0d = loadGeneratorMappingConfigRef(ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "external-mapping")).first(), ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "generator")).first().getAttributeValue("generatorUID"), true);
          result_wk2vdq_a0a1a2a0d.setMappingConfig(result_wk2vdq_a1a0a1a2a0d);
          return result_wk2vdq_a0a1a2a0d;
        }
      }.invoke();
    } else if (ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "mapping-node")).isNotEmpty()) {
      // simple reference 
      ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "mapping-node")).first();

      final MappingConfig_SimpleRef mapping_SimpleRef = new MappingConfig_SimpleRef();
      MappingConfig_SimpleRef result_wk2vdq_a4a3a0d = mapping_SimpleRef;
      final String result_wk2vdq_a0a4a3a0d = ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "mapping-node")).first().getAttributeValue("modelUID");
      result_wk2vdq_a4a3a0d.setModelUID(result_wk2vdq_a0a4a3a0d);
      final String result_wk2vdq_a1a4a3a0d = ListSequence.fromList(AttributeUtils.elementChildren(parentElement, "mapping-node")).first().getAttributeValue("nodeID");
      result_wk2vdq_a4a3a0d.setNodeID(result_wk2vdq_a1a4a3a0d);

      if (childOfGen) {
        return mapping_SimpleRef;
      }

      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a8a3a0d = new MappingConfig_ExternalRef();
          final ModuleReference result_wk2vdq_a0a0a8a3a0d = ModuleReference.fromString(genUID);
          result_wk2vdq_a0a8a3a0d.setGenerator(result_wk2vdq_a0a0a8a3a0d);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a8a3a0d = mapping_SimpleRef;
          result_wk2vdq_a0a8a3a0d.setMappingConfig(result_wk2vdq_a1a0a8a3a0d);
          return result_wk2vdq_a0a8a3a0d;
        }
      }.invoke();
    }

    // empty? 
    return new MappingConfig_AbstractRef();
  }
}

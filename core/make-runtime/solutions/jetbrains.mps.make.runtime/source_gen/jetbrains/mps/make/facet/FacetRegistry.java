package jetbrains.mps.make.facet;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.smodel.language.LanguageRuntime;
import java.util.Collections;

public class FacetRegistry {
  private static Logger LOG = Logger.getLogger(FacetRegistry.class);
  private static FacetRegistry INSTANCE = new FacetRegistry();

  private Map<IFacet.Name, IFacet> facetMap = MapSequence.fromMap(new HashMap<IFacet.Name, IFacet>());

  private FacetRegistry() {
  }

  public void register(IFacet facet) {
    if (MapSequence.fromMap(facetMap).containsKey(facet.getName())) {
      throw new IllegalArgumentException("already registered");
    }
    MapSequence.fromMap(facetMap).put(facet.getName(), facet);
  }

  public void unregister(IFacet facet) {
    if (!(MapSequence.fromMap(facetMap).containsKey(facet.getName()))) {
      throw new IllegalArgumentException("not registered");
    }
    MapSequence.fromMap(facetMap).removeKey(facet.getName());
  }

  public IFacet lookup(IFacet.Name fn) {
    if (ApplicationManager.getApplication() != null) {
      LanguageRegistry langReg = LanguageRegistry.getInstance();
      if (langReg != null) {
        LanguageRuntime lr = langReg.getLanguage(fn.getNamespace());
        if (lr != null) {
          IFacetManifest fm = lr.getFacetProvider().getDescriptor(null).getManifest();
          IFacet fct = fm.lookup(fn);
          if (fct != null) {
            return fct;
          }
        }
      }
    }
    // fallback to the "old" mechanism 
    LOG.debug("facet not found, loading using deprecated mechanism " + fn);
    return MapSequence.fromMap(facetMap).get(fn);
  }

  public Map<IFacet.Name, IFacet> allFacets() {
    return Collections.unmodifiableMap(facetMap);
  }

  public static FacetRegistry getInstance() {
    if (INSTANCE == null) {
      LOG.fatal("not initialized");
      throw new IllegalStateException("not initialized");
    }
    return INSTANCE;
  }
}

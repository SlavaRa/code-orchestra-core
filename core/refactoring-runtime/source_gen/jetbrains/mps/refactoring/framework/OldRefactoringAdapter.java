package jetbrains.mps.refactoring.framework;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.SModel;
import java.util.Map;
import jetbrains.mps.project.IModule;
import java.util.ArrayList;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.workbench.editors.MPSEditorOpener;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.smodel.SModelDescriptor;

@Deprecated
public class OldRefactoringAdapter implements IRefactoring {
  private List<SNode> myNodesToOpen;
  protected AbstractLoggableRefactoring myOldRefactoring;

  @Deprecated
  public OldRefactoringAdapter(AbstractLoggableRefactoring oldRefactoring) {
    myOldRefactoring = oldRefactoring;
  }

  public String getUserFriendlyName() {
    return myOldRefactoring.getUserFriendlyName();
  }

  public String getKeyStroke() {
    return myOldRefactoring.getKeyStroke();
  }

  public Class getOverridenRefactoringClass() {
    return myOldRefactoring.getOverridenRefactoringClass();
  }

  public IRefactoringTarget getRefactoringTarget() {
    return new OldRefactoringAdapter.MyRefactoringTarget();
  }

  public boolean init(RefactoringContext refactoringContext) {
    return myOldRefactoring.askForInfo(refactoringContext);
  }

  public void refactor(final RefactoringContext refactoringContext) {
    myOldRefactoring.doRefactor(refactoringContext);
    myNodesToOpen = myOldRefactoring.getNodesToOpen(refactoringContext);
  }

  public List<SModel> getModelsToGenerate(RefactoringContext refactoringContext) {
    Map<IModule, List<SModel>> modelsToGenerate = myOldRefactoring.getModelsToGenerate(refactoringContext);
    if (modelsToGenerate == null) {
      return new ArrayList<SModel>();
    }
    List<SModel> result = new ArrayList<SModel>();
    for (List<SModel> models : modelsToGenerate.values()) {
      result.addAll(models);
    }
    return result;
  }

  public void doWhenDone(final RefactoringContext refactoringContext) {
    if (myNodesToOpen != null && !(myNodesToOpen.isEmpty())) {
      ApplicationManager.getApplication().invokeLater(new Runnable() {
        public void run() {
          for (SNode nodeToOpen : myNodesToOpen) {
            IOperationContext context = refactoringContext.getCurrentOperationContext();
            context.getComponent(MPSEditorOpener.class).editNode(nodeToOpen, context);
          }
        }
      });
    }
  }

  public SearchResults getAffectedNodes(RefactoringContext refactoringContext) {
    return myOldRefactoring.getAffectedNodes(refactoringContext);
  }

  public String getRefactoringClassName() {
    return myOldRefactoring.getClass().getName();
  }

  public Class getRefactoringClass() {
    return myOldRefactoring.getClass();
  }

  public static IRefactoring createAdapterFor(AbstractLoggableRefactoring oldRefactoring) {
    if (oldRefactoring.doesUpdateModel()) {
      return new OldLoggableRefactoringAdapter(oldRefactoring);
    } else {
      return new OldRefactoringAdapter(oldRefactoring);
    }
  }

  private class MyRefactoringTarget implements IRefactoringTarget {
    private RefactoringTarget myTarget = myOldRefactoring.getRefactoringTarget();

    private MyRefactoringTarget() {
    }

    public IRefactoringTarget.TargetType getTarget() {
      if (myTarget == RefactoringTarget.NODE) {
        return IRefactoringTarget.TargetType.NODE;
      } else
      if (myTarget == RefactoringTarget.MODEL) {
        return IRefactoringTarget.TargetType.MODEL;
      } else {
        return IRefactoringTarget.TargetType.MODULE;
      }
    }

    public boolean allowMultipleTargets() {
      return !(myOldRefactoring.isOneTargetOnly());
    }

    public boolean isApplicable(Object o) {
      if (myTarget == RefactoringTarget.NODE) {
        return myOldRefactoring.isApplicableWRTConcept((SNode) o);
      } else
      if (myTarget == RefactoringTarget.MODEL) {
        return myOldRefactoring.isApplicableToModel((SModelDescriptor) o);
      } else {
        return myOldRefactoring.isApplicableToModule((IModule) o);
      }
    }
  }
}

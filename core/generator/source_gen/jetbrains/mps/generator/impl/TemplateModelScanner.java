package jetbrains.mps.generator.impl;

/*Generated by MPS */

import jetbrains.mps.smodel.SModel;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.LinkedHashSet;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.AttributeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.util.annotation.CodeOrchestraPatch;

public class TemplateModelScanner {
  private SModel myTemplateModel;
  private Set<String> myTargetLanguages;
  private Set<String> myQueryLanguages;

  public TemplateModelScanner(SModel model) {
    myTargetLanguages = SetSequence.fromSet(new LinkedHashSet<String>());
    myQueryLanguages = SetSequence.fromSet(new LinkedHashSet<String>());
    myTemplateModel = model;
  }

  public void scan() {
    for (SNode root : myTemplateModel.roots()) {
      if (SNodeOperations.isInstanceOf(root, "jetbrains.mps.lang.generator.structure.MappingConfiguration")) {
        scanControlNode(root);
      } else if (SNodeOperations.isInstanceOf(root, "jetbrains.mps.lang.generator.structure.TemplateSwitch")) {
        scanControlNode(SNodeOperations.cast(root, "jetbrains.mps.lang.generator.structure.TemplateSwitch"));
      } else if (SNodeOperations.isInstanceOf(root, "jetbrains.mps.lang.generator.structure.TemplateDeclaration")) {
        scanTemplateContextNode(SLinkOperations.getTarget(SNodeOperations.cast(root, "jetbrains.mps.lang.generator.structure.TemplateDeclaration"), "contentNode", true));
        for (SNode n : SLinkOperations.getTargets(SNodeOperations.cast(root, "jetbrains.mps.lang.generator.structure.TemplateDeclaration"), "parameter", true)) {
          scanControlNode(n);
        }
      } else if (SNodeOperations.isInstanceOf(root, "jetbrains.mps.lang.generator.structure.MappingScript")) {
        scanQueryNode(SLinkOperations.getTarget(SLinkOperations.getTarget(SNodeOperations.cast(root, "jetbrains.mps.lang.generator.structure.MappingScript"), "codeBlock", true), "body", true));
      } else if (SNodeOperations.isInstanceOf(root, "jetbrains.mps.lang.generator.structure.GeneratorDescriptor")) {
        // internal root 
      } else {
        if (AttributeOperations.getAttribute(root, new IAttributeDescriptor.NodeAttribute(SConceptOperations.findConceptDeclaration("jetbrains.mps.lang.generator.structure.RootTemplateAnnotation"))) != null) {
          scanTemplateNode(root);
        }
      }
    }
    SetSequence.fromSet(myTargetLanguages).removeElement("jetbrains.mps.lang.generator");
  }

  private void scanTemplateNode(SNode node) {
    SetSequence.fromSet(myTargetLanguages).addElement(node.getLanguageNamespace());
    for (SNode n : node.getChildrenIterable()) {
      if (SNodeOperations.isInstanceOf(n, "jetbrains.mps.lang.generator.structure.NodeMacro") || SNodeOperations.isInstanceOf(n, "jetbrains.mps.lang.generator.structure.RootTemplateAnnotation") || SNodeOperations.isInstanceOf(n, "jetbrains.mps.lang.generator.structure.PropertyMacro") || SNodeOperations.isInstanceOf(n, "jetbrains.mps.lang.generator.structure.ReferenceMacro") || SNodeOperations.isInstanceOf(n, "jetbrains.mps.lang.generator.structure.TemplateFragment")) {
        scanQueryNode(n);
      } else {
        scanTemplateNode(n);
      }
    }
  }

  @CodeOrchestraPatch
  private void scanTemplateContextNode(SNode node) {
    // RF-783
    if (node == null) {
      return;
    }

    if (AttributeOperations.getAttribute(node, new IAttributeDescriptor.NodeAttribute(SConceptOperations.findConceptDeclaration("jetbrains.mps.lang.generator.structure.TemplateFragment"))) != null) {
      scanTemplateNode(node);
      return;
    }
    for (SNode n : node.getChildrenIterable()) {
      scanTemplateContextNode(n);
    }
  }

  @CodeOrchestraPatch
  private void scanControlNode(SNode node) {
    // RF-783
    if (node == null) {
      return;
    }

    if (SNodeOperations.isInstanceOf(node, "jetbrains.mps.lang.generator.structure.InlineTemplateWithContext_RuleConsequence")) {
      scanTemplateContextNode(SLinkOperations.getTarget(SNodeOperations.cast(node, "jetbrains.mps.lang.generator.structure.InlineTemplateWithContext_RuleConsequence"), "contentNode", true));
    } else if (SNodeOperations.isInstanceOf(node, "jetbrains.mps.lang.generator.structure.InlineTemplate_RuleConsequence")) {
      scanTemplateNode(SLinkOperations.getTarget(SNodeOperations.cast(node, "jetbrains.mps.lang.generator.structure.InlineTemplate_RuleConsequence"), "templateNode", true));
    } else if (SNodeOperations.isInstanceOf(node, "jetbrains.mps.lang.generator.structure.PatternReduction_MappingRule")) {
      // ignore pattern 
      scanControlNode(SLinkOperations.getTarget(SNodeOperations.cast(node, "jetbrains.mps.lang.generator.structure.PatternReduction_MappingRule"), "ruleConsequence", true));
      scanQueryNode(SLinkOperations.getTarget(SNodeOperations.cast(node, "jetbrains.mps.lang.generator.structure.PatternReduction_MappingRule"), "conditionFunction", true));
    } else {
      if ("jetbrains.mps.lang.generator".equals(node.getLanguageNamespace())) {
        for (SNode child : node.getChildrenIterable()) {
          scanControlNode(child);
        }
      } else {
        scanQueryNode(node);
      }
    }
  }

  private void scanQueryNode(SNode node) {
    if ((node == null)) {
      return;
    }
    for (SNode n : node.getDescendantsIterable(null, true)) {
      SetSequence.fromSet(myQueryLanguages).addElement(n.getLanguageNamespace());
    }
  }

  public Set<String> getTargetLanguages() {
    return myTargetLanguages;
  }

  public Set<String> getQueryLanguages() {
    return myQueryLanguages;
  }
}

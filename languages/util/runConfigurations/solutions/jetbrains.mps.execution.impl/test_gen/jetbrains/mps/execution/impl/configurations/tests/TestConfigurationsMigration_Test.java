package jetbrains.mps.execution.impl.configurations.tests;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.util.plugin.run.MPSLaunch;
import jetbrains.mps.lang.test.runtime.BaseTransformationTest;
import org.junit.Test;
import jetbrains.mps.lang.test.runtime.BaseTestBody;
import org.jdom.Element;
import junit.framework.Assert;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.project.ProjectManager;
import com.intellij.execution.impl.RunManagerImpl;
import jetbrains.mps.execution.impl.configurations.RunConfigurationsStateManager;
import com.intellij.execution.impl.RunnerAndConfigurationSettingsImpl;
import com.intellij.execution.configurations.UnknownConfigurationType;
import com.intellij.openapi.util.InvalidDataException;

@MPSLaunch
public class TestConfigurationsMigration_Test extends BaseTransformationTest {
  @Test
  public void test_java() throws Throwable {
    this.initTest("${mps_home}/workbench/runConfigurations/runConfigurations.mpr", "r:00c1e1d0-e3c4-4d43-82f5-4c4f80539a57(jetbrains.mps.execution.impl.configurations.tests@tests)");
    this.runTest("jetbrains.mps.execution.impl.configurations.tests.TestConfigurationsMigration_Test$TestBody", "test_java", true);
  }

  @Test
  public void test_junit() throws Throwable {
    this.initTest("${mps_home}/workbench/runConfigurations/runConfigurations.mpr", "r:00c1e1d0-e3c4-4d43-82f5-4c4f80539a57(jetbrains.mps.execution.impl.configurations.tests@tests)");
    this.runTest("jetbrains.mps.execution.impl.configurations.tests.TestConfigurationsMigration_Test$TestBody", "test_junit", true);
  }

  @MPSLaunch
  public static class TestBody extends BaseTestBody {
    public void test_java() throws Exception {
      this.testConfigurationMigrated("old.java.configuration.xml");
    }

    public void test_junit() throws Exception {
      this.testConfigurationMigrated("old.junit.configuration.xml");
    }

    public void testConfigurationMigrated(String configFile) {
      Element element = XslTest.readAndTransform(configFile);
      Assert.assertTrue(element.getChildren().size() > 0);

      Project project = ProjectManager.getInstance().getOpenProjects()[0];
      RunManagerImpl runManagerImpl = RunManagerImpl.getInstanceImpl(project);
      runManagerImpl.initializeConfigurationTypes(RunConfigurationsStateManager.getConfigurationTypes());

      for (Object child : element.getChildren()) {
        RunnerAndConfigurationSettingsImpl settings = new RunnerAndConfigurationSettingsImpl(runManagerImpl);
        try {
          settings.readExternal((Element) child);
          Assert.assertFalse(settings.getConfiguration().getType() instanceof UnknownConfigurationType);
        } catch (InvalidDataException e) {
          Assert.fail(e.getMessage());
        }
      }
    }
  }
}

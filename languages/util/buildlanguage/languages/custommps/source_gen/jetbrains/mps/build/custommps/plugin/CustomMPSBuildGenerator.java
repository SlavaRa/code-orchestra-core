package jetbrains.mps.build.custommps.plugin;

/*Generated by MPS */

import jetbrains.mps.build.packaging.plugin.BuildGeneratorImpl;
import com.intellij.openapi.project.Project;
import org.apache.commons.lang.StringUtils;
import java.util.List;
import jetbrains.mps.project.structure.modules.ModuleReference;
import java.util.Arrays;
import jetbrains.mps.build.packaging.plugin.BuildGeneratorUtil;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;
import jetbrains.mps.build.packaging.plugin.NodeData;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.util.MacrosFactory;
import java.io.File;
import jetbrains.mps.build.packaging.plugin.PackagingLanguageGenerator;
import jetbrains.mps.build.packaging.behavior.IStringExpression_Behavior;

public class CustomMPSBuildGenerator extends BuildGeneratorImpl {
  private String myPathToBuildTools = "";

  public CustomMPSBuildGenerator(Project project) {
    super(project);
  }

  public void setPathToBuildTools(String path) {
    this.myPathToBuildTools = path;
  }

  public String getPathToBuildTools() {
    return this.myPathToBuildTools;
  }

  public boolean isValid() {
    return super.isValid() && StringUtils.isNotEmpty(this.myPathToBuildTools);
  }

  protected List<ModuleReference> getModuleReferencesToAdd() {
    return Arrays.asList(BuildGeneratorUtil.getPackagingLanguageReference(), MPSModuleRepository.getInstance().getLanguage("jetbrains.mps.build.custommps").getModuleReference());
  }

  public Runnable generate(final EditableSModelDescriptor targetModelDescriptor, String name, String basedir, List<NodeData> selectedData) {
    final SNode mpsLayout = this.createMPSLayout(targetModelDescriptor, name, basedir, selectedData);

    SNode zipNode = SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(mpsLayout, "component", true)).first(), "jetbrains.mps.build.packaging.structure.Zip");
    SNode rootFolder = SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(zipNode, "entry", true)).first(), "jetbrains.mps.build.packaging.structure.Folder");
    List<SNode> entries = SLinkOperations.getTargets(rootFolder, "entry", true);
    SNode mpsBuild = SConceptOperations.createNewNode("jetbrains.mps.build.custommps.structure.MPSBuild", null);
    ListSequence.fromList(SLinkOperations.getTargets(mpsLayout, "component", true)).addElement(mpsBuild);

    SNode libraryFolder = createLibraryFolder(rootFolder);
    for (SNode entry : ListSequence.fromList(entries)) {
      if (SNodeOperations.isInstanceOf(entry, "jetbrains.mps.build.packaging.structure.Module")) {
        ListSequence.fromList(SLinkOperations.getTargets(libraryFolder, "entry", true)).addElement(entry);
      } else if (SNodeOperations.isInstanceOf(entry, "jetbrains.mps.build.packaging.structure.Folder")) {
        SNode oldFolder = SNodeOperations.cast(entry, "jetbrains.mps.build.packaging.structure.Folder");
        SNode newFolder = createLibraryFolder(oldFolder);
        ListSequence.fromList(SLinkOperations.getTargets(newFolder, "entry", true)).addSequence(ListSequence.fromList(SLinkOperations.getTargets(oldFolder, "entry", true)));
        ListSequence.fromList(SLinkOperations.getTargets(mpsBuild, "entry", true)).addElement(newFolder);
      }
    }
    if (ListSequence.fromList(SLinkOperations.getTargets(libraryFolder, "entry", true)).isNotEmpty()) {
      ListSequence.fromList(SLinkOperations.getTargets(mpsBuild, "entry", true)).addElement(libraryFolder);
    }
    SNodeOperations.deleteNode(zipNode);

    //  setting buildtools.zip path 
    SNode buildToolsPath = SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.Path", null);
    String result = MacrosFactory.mpsHomeMacros().shrinkPath(this.myPathToBuildTools, new File("")).replace("\\", File.separator);
    int index = result.lastIndexOf("}");
    if (index > -1) {
      String macro = result.substring(result.indexOf("{") + 1, index);
      PackagingLanguageGenerator.createPath(buildToolsPath, macro, result.substring(index + 2));
    } else {
      PackagingLanguageGenerator.createPath(buildToolsPath, "", this.myPathToBuildTools);
    }
    SLinkOperations.setTarget(mpsBuild, "pathToBuildToolsZip", buildToolsPath, true);
    return new Runnable() {
      public void run() {
        CustomMPSBuildGenerator.this.finishGeneration(targetModelDescriptor, mpsLayout);
      }
    };
  }

  public static SNode createLibraryFolder(SNode prototypeFolder) {
    SNode libraryFolder = SConceptOperations.createNewNode("jetbrains.mps.build.custommps.structure.LibraryFolder", null);
    SLinkOperations.setTarget(libraryFolder, "sourcePath", SLinkOperations.getTarget(prototypeFolder, "sourcePath", true), true);
    SLinkOperations.setTarget(libraryFolder, "title", SLinkOperations.getTarget(prototypeFolder, "title", true), true);
    SLinkOperations.setTarget(libraryFolder, "libraryName", PackagingLanguageGenerator.createSimpleString(IStringExpression_Behavior.call_getValue_1213877173054(SLinkOperations.getTarget(libraryFolder, "title", true)).toLowerCase()), true);
    return libraryFolder;
  }
}

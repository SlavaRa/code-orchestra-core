package jetbrains.mps.project;

/*Generated by MPS */

import jetbrains.mps.ide.vfs.BaseDirectoryIndexExcludePolicy;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.project.Project;
import java.util.Set;
import com.intellij.openapi.vfs.VirtualFile;
import jetbrains.mps.vcs.MPSVcsProjectConfiguration;
import java.util.Collections;
import java.util.HashSet;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.SModelRepository;
import com.intellij.openapi.vfs.LocalFileSystem;
import jetbrains.mps.generator.fileGenerator.FileGenerationUtil;

public class GeneratedFilesExcludePolicy extends BaseDirectoryIndexExcludePolicy {
  protected GeneratedFilesExcludePolicy(@NotNull Project project) {
    super(project);
  }

  @NotNull
  @Override
  protected Set<VirtualFile> getAllExcludeRoots() {
    if (!(MPSVcsProjectConfiguration.getInstance(getProject()).isIgnoreGeneratedFiles())) {
      return Collections.EMPTY_SET;
    }
    Set<VirtualFile> roots = new HashSet<VirtualFile>();
    for (SModelDescriptor modelDescriptor : SModelRepository.getInstance().getModelDescriptors()) {
      IModule module = modelDescriptor.getModule();
      if (module != null) {
        String outputPath = module.getOutputFor(modelDescriptor);
        if (outputPath != null) {
          VirtualFile outputDir = LocalFileSystem.getInstance().findFileByPath(outputPath);
          VirtualFile cachesDir = LocalFileSystem.getInstance().findFileByPath(FileGenerationUtil.getCachesPath(outputPath));
          if (outputDir != null) {
            roots.add(outputDir);
          } else {
          }
          if (cachesDir != null) {
            roots.add(cachesDir);
          } else {
          }
        }
      }
    }
    return roots;
  }
}

package jetbrains.mps.vcs.mergedriver;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import com.intellij.openapi.project.Project;
import org.jetbrains.annotations.NotNull;
import git4idea.config.GitConfigUtil;
import com.intellij.openapi.vcs.VcsException;
import com.intellij.openapi.ui.Messages;
import git4idea.commands.GitSimpleHandler;
import git4idea.commands.GitCommand;

/*package*/ class GitGlobalConfigFixesInstaller extends AbstractInstaller {
  private static final String CORE_AUTOCRLF = "core.autocrlf";
  private static final String CORE_AUTOCRLF_VALUE = "input";
  protected static Log log = LogFactory.getLog(GitGlobalConfigFixesInstaller.class);

  public GitGlobalConfigFixesInstaller(Project project) {
    super(project);
  }

  @NotNull
  protected AbstractInstaller.State install(boolean dryRun) {
    try {
      String currentValue = GitConfigUtil.getValue(myProject, myProject.getBaseDir(), GitGlobalConfigFixesInstaller.CORE_AUTOCRLF);
      if (CORE_AUTOCRLF_VALUE.equals(currentValue)) {
        return AbstractInstaller.State.INSTALLED;
      }
    } catch (VcsException e) {
      if (!(dryRun)) {
        if (log.isWarnEnabled()) {
          log.warn("Can't get value", e);
        }
      }
      return AbstractInstaller.State.NOT_INSTALLED;
    }

    if (dryRun) {
      return AbstractInstaller.State.NOT_INSTALLED;
    }

    try {
      setGlobalProperty(myProject, CORE_AUTOCRLF, CORE_AUTOCRLF_VALUE);
      return AbstractInstaller.State.INSTALLED;
    } catch (VcsException e) {
      if (log.isWarnEnabled()) {
        log.warn("Can't set value", e);
      }
      Messages.showErrorDialog(myProject, "Can't set Git global property: " + e.getMessage(), "Git Global property");
      return AbstractInstaller.State.NOT_INSTALLED;
    }
  }

  public String getActionTitle() {
    return "Git global autocrlf setting (~/.gitconfig)";
  }

  @Override
  public String getActionTooltip() {
    return "Set core.autocrlf to input";
  }

  public String getAffectedVcsName() {
    return "Git";
  }

  private static void setGlobalProperty(Project project, String key, String value) throws VcsException {
    GitSimpleHandler h = new GitSimpleHandler(project, project.getBaseDir(), GitCommand.CONFIG);
    h.setNoSSH(true);
    h.setSilent(true);
    h.ignoreErrorCode(1);
    h.addParameters("--global", key, value);
    h.run();
  }
}

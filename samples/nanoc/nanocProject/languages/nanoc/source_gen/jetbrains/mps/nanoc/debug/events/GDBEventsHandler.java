package jetbrains.mps.nanoc.debug.events;

/*Generated by MPS */

import com.intellij.execution.process.ProcessHandler;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.nanoc.debug.answer.StreamAnswer;
import com.intellij.execution.process.ProcessAdapter;
import com.intellij.execution.process.ProcessEvent;
import com.intellij.openapi.util.Key;
import jetbrains.mps.nanoc.debug.answer.GDBAnswerProducer;
import jetbrains.mps.nanoc.debug.answer.GDBAnswer;
import jetbrains.mps.nanoc.debug.answer.AsyncAnswer;
import jetbrains.mps.nanoc.debug.answer.GDBValue;
import jetbrains.mps.nanoc.debug.answer.StringValue;
import jetbrains.mps.nanoc.debug.answer.ResultAnswer;

public class GDBEventsHandler {
  public static final String REASON = "reason";
  public static final String REASON_BP_HIT = "breakpoint-hit";
  public static final String REASON_EXITED_NORMALLY = "exited-normally";
  public static final String REASON_EXITED = "exited";

  private ProcessHandler myProcessHandler;
  private List<GDBEventsListener> myEventsListeners = new ArrayList<GDBEventsListener>();
  private List<StreamAnswer> myPendingStreamAnswers = new ArrayList<StreamAnswer>();

  public GDBEventsHandler(ProcessHandler gdbProcess) {
    myProcessHandler = gdbProcess;
    myProcessHandler.addProcessListener(new ProcessAdapter() {
      public void onTextAvailable(ProcessEvent event, Key outputType) {
        String text = event.getText();
        GDBAnswerProducer producer = new GDBAnswerProducer(text);
        GDBAnswer gdbAnswer = producer.getGDBAnswer();
        if (producer.hasError() || gdbAnswer == null) {
          return;
        }
        if (gdbAnswer instanceof AsyncAnswer) {
          AsyncAnswer answer = (AsyncAnswer) gdbAnswer;
          if (answer.isExec() && answer.isStopped()) {
            GDBValue reasonRaw = answer.getResults().getPropertyValue(GDBEventsHandler.REASON);
            String reason = (reasonRaw instanceof StringValue ?
              ((StringValue) reasonRaw).getString() :
              null
            );
            if (GDBEventsHandler.REASON_EXITED_NORMALLY.equals(reason) || GDBEventsHandler.REASON_EXITED.equals(reason)) {
              fireProcessTerminated();
              return;
            } else {
              firePaused(answer);
              return;
            }
          }
        }
        if (gdbAnswer instanceof StreamAnswer) {
          StreamAnswer streamAnswer = (StreamAnswer) gdbAnswer;
          myPendingStreamAnswers.add(streamAnswer);
        }
        if (gdbAnswer instanceof ResultAnswer) {
          ResultAnswer resultAnswer = (ResultAnswer) gdbAnswer;
          List<StreamAnswer> receivedStreamAnswers = new ArrayList<StreamAnswer>(myPendingStreamAnswers);
          myPendingStreamAnswers.clear();
          fireResultReceived(resultAnswer, receivedStreamAnswers);
          return;
        }
      }

      public void processTerminated(ProcessEvent event) {
        fireGDBProcessTerminated();
      }
    });
  }

  private void fireProcessTerminated() {
    for (GDBEventsListener listener : getEventsListeners()) {
      listener.processTerminated(myProcessHandler);
    }
  }

  private void fireGDBProcessTerminated() {
    for (GDBEventsListener listener : getEventsListeners()) {
      listener.gdbProcessTerminated(myProcessHandler);
    }
  }

  private void firePaused(AsyncAnswer gdbAnswer) {
    for (GDBEventsListener listener : getEventsListeners()) {
      listener.paused(gdbAnswer, myProcessHandler);
    }
  }

  private void fireResultReceived(ResultAnswer gdbAnswer, List<StreamAnswer> receivedStreamAnswers) {
    for (GDBEventsListener listener : getEventsListeners()) {
      listener.resultReceived(gdbAnswer, receivedStreamAnswers, myProcessHandler);
    }
  }

  public List<GDBEventsListener> getEventsListeners() {
    return new ArrayList<GDBEventsListener>(myEventsListeners);
  }

  public void addEventListener(GDBEventsListener listener) {
    myEventsListeners.add(listener);
  }

  public void removeEventListener(GDBEventsListener listener) {
    myEventsListeners.remove(listener);
  }

  public ProcessHandler getGDBProcessHandler() {
    return myProcessHandler;
  }
}

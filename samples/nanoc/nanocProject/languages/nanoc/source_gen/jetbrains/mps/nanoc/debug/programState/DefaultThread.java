package jetbrains.mps.nanoc.debug.programState;

/*Generated by MPS */

import jetbrains.mps.debug.api.programState.IThread;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.nanoc.debug.CppDebugSession;
import jetbrains.mps.nanoc.debug.answer.ResultAnswer;
import jetbrains.mps.nanoc.debug.answer.ListMapValue;
import jetbrains.mps.nanoc.debug.answer.GDBValue;
import jetbrains.mps.nanoc.debug.answer.RecordValue;
import jetbrains.mps.debug.api.programState.IStackFrame;
import javax.swing.Icon;
import jetbrains.mps.nanoc.debug.requests.GDBRequestor;
import jetbrains.mps.nanoc.debug.answer.StreamAnswer;

public abstract class DefaultThread implements IThread {
  public static final String STACK = "stack";
  public static final String FRAME = "frame";

  private List<GDBStackFrame> myFrames = new ArrayList<GDBStackFrame>();
  private CppDebugSession myDebugSession;

  public DefaultThread(ResultAnswer resultAnswer, String sourceGen, CppDebugSession debugSession) {
    myDebugSession = debugSession;
    ListMapValue listMapValue = (ListMapValue) resultAnswer.getResults().getPropertyValue(STACK);
    for (GDBValue value : listMapValue.getValues()) {
      RecordValue recordValue = (RecordValue) value;
      GDBStackFrame gdbStackFrame = new GDBStackFrame(recordValue, this, sourceGen);
      myFrames.add(gdbStackFrame);
    }
    if (!(myFrames.isEmpty())) {
      myDebugSession.getGDBRequestManager().createRequest(new DefaultThread.MyRequestor1(0));
    } else {
      whenCreated();
    }
  }

  public List<IStackFrame> getFrames() {
    return new ArrayList<IStackFrame>(myFrames);
  }

  public int getFramesCount() {
    return myFrames.size();
  }

  public String getName() {
    return "DEFAULT";
  }

  public String getPresentation() {
    return "Default";
  }

  public Icon getPresentationIcon() {
    return null;
  }

  public abstract void whenCreated();

  private class MyRequestor1 extends GDBRequestor {
    private int myLevel;

    public MyRequestor1(int level) {
      myLevel = level;
    }

    public String createRequestString() {
      return "-stack-select-frame " + myLevel;
    }

    public void onRequestFulfilled(ResultAnswer answer, List<StreamAnswer> receivedStreamAnswers) {
      myDebugSession.getGDBRequestManager().createRequest(new DefaultThread.MyRequestor2(myLevel));
    }
  }

  private class MyRequestor2 extends GDBRequestor {
    private int myLevel;

    public MyRequestor2(int level) {
      myLevel = level;
    }

    public String createRequestString() {
      return "-stack-list-locals 2";
    }

    public void onRequestFulfilled(ResultAnswer answer, List<StreamAnswer> receivedStreamAnswers) {
      myFrames.get(myLevel).fillLocals(answer);
      if (myLevel + 1 < myFrames.size()) {
        myDebugSession.getGDBRequestManager().createRequest(new DefaultThread.MyRequestor1(myLevel + 1));
      } else {
        whenCreated();
      }
    }
  }
}

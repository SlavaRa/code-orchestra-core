package jetbrains.mps.nanoc.debug.breakpoints;

/*Generated by MPS */

import jetbrains.mps.debug.api.breakpoints.AbstractBreakpoint;
import jetbrains.mps.debug.api.breakpoints.IBreakpoint;
import jetbrains.mps.debug.api.breakpoints.ILocationBreakpoint;
import jetbrains.mps.nanoc.debug.requests.BreakpointRequestor;
import jetbrains.mps.debug.api.breakpoints.BreakpointLocation;
import jetbrains.mps.smodel.SNodePointer;
import com.intellij.openapi.project.Project;
import jetbrains.mps.nanoc.debug.CppDebugSession;
import jetbrains.mps.nanoc.debug.requests.GDBRequestManager;
import jetbrains.mps.nanoc.debug.answer.ResultAnswer;
import java.util.List;
import jetbrains.mps.nanoc.debug.answer.StreamAnswer;
import jetbrains.mps.nanoc.debug.answer.RecordValue;
import jetbrains.mps.nanoc.debug.answer.StringValue;
import jetbrains.mps.nanoc.debug.requests.RemoveBreakpointRequestor;
import org.jetbrains.annotations.NonNls;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.debug.api.BreakpointInfo;
import jetbrains.mps.debug.api.breakpoints.IBreakpointKind;

public class GDBBreakpoint extends AbstractBreakpoint implements IBreakpoint, ILocationBreakpoint {
  private static final String BKPT = "bkpt";
  private static final String NUMBER = "number";

  private BreakpointRequestor myBreakpointRequestor;
  private boolean myAdded = false;
  private int myInternalGDBNumber = -1;
  private final BreakpointLocation myLocation;

  public GDBBreakpoint(SNodePointer nodePointer, Project project) {
    super(project);
    myLocation = new BreakpointLocation(nodePointer);
  }

  public void removeFromRunningSessions() {
    CppDebugSession.performAllSessionsAction(myProject, new CppDebugSession.DebugSessionAction() {
      public void run(CppDebugSession debugSession) {
        createRemoveBreakpointRequest(debugSession.getGDBRequestManager());
      }
    });
  }

  public void addToRunningSessions() {
    CppDebugSession.performAllSessionsAction(myProject, new CppDebugSession.DebugSessionAction() {
      public void run(CppDebugSession debugSession) {
        createBreakpointRequest(debugSession.getGDBRequestManager());
      }
    });
  }

  public void createBreakpointRequest(GDBRequestManager requestManager) {
    requestManager.createRequest(new BreakpointRequestor(getLocation().getFileName(), getLocation().getLineIndexInFile()) {
      public void onRequestFulfilled(ResultAnswer answer, List<StreamAnswer> receivedStreamAnswers) {
        myAdded = true;
        RecordValue bkptInfo = (RecordValue) answer.getResults().getPropertyValue(GDBBreakpoint.BKPT);
        StringValue numberValue = (StringValue) bkptInfo.getPropertyValue(GDBBreakpoint.NUMBER);
        int number = Integer.parseInt(numberValue.getString());
        myInternalGDBNumber = number;
      }
    });
  }

  public void createRemoveBreakpointRequest(GDBRequestManager requestManager) {
    requestManager.createRequest(new RemoveBreakpointRequestor(myInternalGDBNumber) {
      public void onRequestFulfilled(ResultAnswer answer, List<StreamAnswer> receivedStreamAnswers) {
        myAdded = false;
        myInternalGDBNumber = -1;
      }
    });
  }

  @NonNls
  public String getPresentation() {
    return myLocation.getPresentation();
  }

  @NotNull
  public GDBBreakpoint.GDBBreakpointKind getKind() {
    return GDBBreakpoint.GDBBreakpointKind.LINE_BREAKPOINT;
  }

  @NotNull
  public BreakpointLocation getLocation() {
    return myLocation;
  }

  public BreakpointInfo getState() {
    return new BreakpointInfo(this, myLocation);
  }

  public static GDBBreakpoint fromInfo(@NotNull BreakpointInfo info, Project project) {
    return new GDBBreakpoint(new SNodePointer(info.myModelReference, info.myNodeId), project);
  }

  public class GdbBreakpointState {
    public String myNodeId;
    public String myModelId;

    public GdbBreakpointState() {
    }
  }

  public static   enum GDBBreakpointKind implements IBreakpointKind<GDBBreakpoint> {
    LINE_BREAKPOINT();

    GDBBreakpointKind() {
    }

    @NonNls
    public String getPresentation() {
      return "Cpp Line Breakpoint";
    }

    @NonNls
    public String getName() {
      return "CPP_LINE_BREAKPOINT";
    }

    public boolean supportsDisable() {
      return true;
    }
  }
}
